import pandas as pd
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
from selenium.common.exceptions import TimeoutException
import time

# ---------------- Setup ----------------
chrome_options = Options()
chrome_options.add_argument("--start-maximized")

service = Service(r"C:\Users\Lenovo\Downloads\chromedriver-win64 (1)\chromedriver-win64\chromedriver.exe")
driver = webdriver.Chrome(service=service, options=chrome_options)

driver.get("https://www.rewe.de/shop")
time.sleep(3)

# Click initial entry button
WebDriverWait(driver, 10).until(
    EC.element_to_be_clickable((By.ID, "intentionButtonList"))
).click()

# ---------------- Zip codes list ----------------
zip_codes = numbers = [
"70839","70825","70989","70988","70987","70986","70985","70984","70983","70982","70981","70980",
"70979","70978","70977","70976","70975","70974","70973","70972","70971","70970",
"70969","70968","70967","70966","70965","70964","70963","70962","70961","70960",
"70959","70958","70957","70956","70955","70954","70953","70952","70951","70950",
"70949","70948","70947","70946","70945","70944","70943","70942","70941","70940",
"70939","70938","70937","70936","70935","70934","70933","70932","70931","70930",
"70929","70928","70927","70926","70925","70924","70923","70922","70921","70920",
"70919","70918","70917","70916","70915","70914","70913","70912","70911","70910",
"70909","70908","70907","70906","70905","70904","70903","70902","70901","70900",
"70899","70898","70897","70896","70895","70894","70893","70892","70891","70890",
"70889","70888","70887","70886","70885","70884","70883","70882","70881","70880",
"70879","70878","70877","70876","70875","70874","70873","70872","70871","70870",
"70869","70868","70867","70866","70865","70864","70863","70862","70861","70860",
"70859","70858","70857","70856","70855","70854","70853","70852","70851","70850",
"70849","70848","70847","70846","70845","70844","70843","70842","70841","70840",
"70839","70838","70837","70836","70835","70834","70833","70832","70831","70830",
"70829","70828","70827","70826","70825","70824","70823","70822","70821","70820",
"70819","70818","70817","70816","70815","70814","70813","70812","70811","70810",
"70809","70808","70807","70806","70805","70804","70803","70802","70801","70800",
"70799","70798","70797","70796","70795","70794","70793","70792","70791","70790",
"70789","70788","70787","70786","70785","70784","70783","70782","70781","70780",
"70779","70778","70777","70776","70775","70774","70773","70772","70771","70770",
"70769","70768","70767","70766","70765","70764","70763","70762","70761","70760",
"70759","70758","70757","70756","70755","70754","70753","70752","70751","70750",
"70749","70748","70747","70746","70745","70744","70743","70742","70741","70740",
"70739","70738","70737","70736","70735","70734","70733","70732","70731","70730",
"70729","70728","70727","70726","70725","70724","70723","70722","70721","70720",
"70719","70718","70717","70716","70715","70714","70713","70712","70711","70710",
"70709","70708","70707","70706","70705","70704","70703","70702","70701","70700",
"70699","70698","70697","70696","70695","70694","70693","70692","70691","70690",
"70689","70688","70687","70686","70685","70684","70683","70682","70681","70680",
"70679","70678","70677","70676","70675","70674","70673","70672","70671","70670",
"70669","70668","70667","70666","70665","70664","70663","70662","70661","70660",
"70659","70658","70657","70656","70655","70654","70653","70652","70651","70650",
"70649","70648","70647","70646","70645","70644","70643","70642","70641","70640",
"70639","70638","70637","70636","70635","70634","70633","70632","70631","70630",
"70629","70628","70627","70626","70625","70624","70623","70622","70621","70620",
"70619","70618","70617","70616","70615","70614","70613","70612","70611","70610",
"70609","70608","70607","70606","70605","70604","70603","70602","70601","70600",
"70599","70598","70597","70596","70595","70594","70593","70592","70591","70590",
"70589","70588","70587","70586","70585","70584","70583","70582","70581","70580",
"70579","70578","70577","70576","70575","70574","70573","70572","70571","70570",
"70569","70568","70567","70566","70565","70564","70563","70562","70561","70560",
"70559","70558","70557","70556","70555","70554","70553","70552","70551","70550",
"70549","70548","70547","70546","70545","70544","70543","70542","70541","70540",
"70539","70538","70537","70536","70535","70534","70533","70532","70531","70530",
"70529","70528","70527","70526","70525","70524","70523","70522","70521","70520",
"70519","70518","70517","70516","70515","70514","70513","70512","70511","70510",
"70509","70508","70507","70506","70505","70504","70503","70502","70501","70500",
"70499","70498","70497","70496","70495","70494","70493","70492","70491","70490",
"70489","70488","70487","70486","70485","70484","70483","70482","70481","70480",
"70479","70478","70477","70476","70475","70474","70473","70472","70471","70470",
"70469","70468","70467","70466","70465","70464","70463","70462","70461","70460",
"70459","70458","70457","70456","70455","70454","70453","70452","70451","70450",
"70449","70448","70447","70446","70445","70444","70443","70442","70441","70440",
"70439","70438","70437","70436","70435","70434","70433","70432","70431","70430",
"70429","70428","70427","70426","70425","70424","70423","70422","70421","70420",
"70419","70418","70417","70416","70415","70414","70413","70412","70411","70410",
"70409","70408","70407","70406","70405","70404","70403","70402","70401","70400",
"70399","70398","70397","70396","70395","70394","70393","70392","70391","70390",
"70389","70388","70387","70386","70385","70384","70383","70382","70381","70380",
"70379","70378","70377","70376","70375","70374","70373","70372","70371","70370",
"70369","70368","70367","70366","70365","70364","70363","70362","70361","70360",
"70359","70358","70357","70356","70355","70354","70353","70352","70351","70350",
"70349","70348","70347","70346","70345","70344","70343","70342","70341","70340",
"70339","70338","70337","70336","70335","70334","70333","70332","70331","70330",
"70329","70328","70327","70326","70325","70324","70323","70322","70321","70320",
"70319","70318","70317","70316","70315","70314","70313","70312","70311","70310",
"70309","70308","70307","70306","70305","70304","70303","70302","70301","70300",
"70299","70298","70297","70296","70295","70294","70293","70292","70291","70290",
"70289","70288","70287","70286","70285","70284","70283","70282","70281","70280",
"70279","70278","70277","70276","70275","70274","70273","70272","70271","70270",
"70269","70268","70267","70266","70265","70264","70263","70262","70261","70260",
"70259","70258","70257","70256","70255","70254","70253","70252","70251","70250",
"70249","70248","70247","70246","70245","70244","70243","70242","70241","70240",
"70239","70238","70237","70236","70235","70234","70233","70232","70231","70230",
"70229","70228","70227","70226","70225","70224","70223","70222","70221","70220",
"70219","70218","70217","70216","70215","70214","70213","70212","70211","70210",
"70209","70208","70207","70206","70205","70204","70203","70202","70201","70200",
"70199","70198","70197","70196","70195","70194","70193","70192","70191","70190",
"70189","70188","70187","70186","70185","70184","70183","70182","70181","70180",
"70179","70178","70177","70176","70175","70174","70173","70172","70171","70170",
"70169","70168","70167","70166","70165","70164","70163","70162","70161","70160",
"70159","70158","70157","70156","70155","70154","70153","70152","70151","70150",
"70149","70148","70147","70146","70145","70144","70143","70142","70141","70140",
"70139","70138","70137","70136","70135","70134","70133","70132","70131","70130",
"70129","70128","70127","70126","70125","70124","70123","70122","70121","70120",
"70119","70118","70117","70116","70115","70114","70113","70112","70111","70110",
"70109","70108","70107","70106","70105","70104","70103","70102","70101","70100",
"70099","70098","70097","70096","70095","70094","70093","70092","70091","70090",
"70089","70088","70087","70086","70085","70084","70083","70082","70081","70080",
"70079","70078","70077","70076","70075","70074","70073","70072","70071","70070",
"70069","70068","70067","70066","70065","70064","70063","70062","70061","70060",
"70059","70058","70057","70056","70055","70054","70053","70052","70051","70050",
"70049","70048","70047","70046","70045","70044","70043","70042","70041","70040",
"70039","70038","70037","70036","70035","70034","70033","70032","70031","70030",
"70029","70028","70027","70026","70025","70024","70023","70022","70021","70020",
"70019","70018","70017","70016","70015","70014","70013","70012","70011","70010",
"70009","70008","70007","70006","70005","70004","70003","70002","70001","70000",
"69999","69998","69997","69996","69995","69994","69993","69992","69991","69990"
]



# Store results here
results = []

# ---------------- Loop through zip codes ----------------
for zc in zip_codes:
    try:
        print(f"\nProcessing zip code: {zc}")

        # Step 1: Enter zip code
        try:
            zip_input = WebDriverWait(driver, 5).until(
                EC.element_to_be_clickable((By.CLASS_NAME, "gbmc-zipcode-input"))
            )
            zip_input.clear()
            zip_input.send_keys(zc + Keys.ENTER)
        except TimeoutException:
            print("Zip input not available, maybe we're already in checkout flow.")

        time.sleep(2)

        # Step 2: Check for available buttons
        try:
            element = WebDriverWait(driver, 5).until(
                EC.any_of(
                    EC.presence_of_element_located((By.CLASS_NAME, "gbmc-back-button")),
                    EC.presence_of_element_located((By.CLASS_NAME, "gbmc-change-zipcode-link"))
                )
            )
            # ✅ If found → availability = Yes
            results.append({"zipcode": zc, "availability": "Yes"})

            # Re-find element to avoid stale reference
            element = driver.find_element(By.CLASS_NAME, element.get_attribute("class").split()[0])

            if "gbmc-back-button" in element.get_attribute("class"):
                print(f"Zip {zc} accepted -> back button present.")
                element.click()
            elif "gbmc-change-zipcode-link" in element.get_attribute("class"):
                print(f"Zip {zc} accepted -> change zip link present.")
                element.click()

        except TimeoutException:
            # ❌ If not found → availability = No
            print(f"Neither back nor change-zip buttons present for zip {zc}, marking as No...")
            results.append({"zipcode": zc, "availability": "No"})

            # Recovery flow
            try:
                headed_back = WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((By.CLASS_NAME, "gbmc-headed-back-button"))
                )
                headed_back.click()
                time.sleep(1)

                WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((By.ID, "intentionButtonList"))
                ).click()
                time.sleep(1)
                print(f"Recovered successfully for zip {zc}")

            except Exception:
                print(f"Recovery failed for zip {zc}")
                continue

    except Exception as e:
        print(f"Unexpected error with zip {zc}: {e}")
        results.append({"zipcode": zc, "availability": "No"})

time.sleep(5)
driver.quit()

# ---------------- Save results ----------------
df = pd.DataFrame(results)
df.to_csv("zipcode_availability31000.csv", index=False)
print("\n✅ Dataset saved as zip_availability.csv")

import pandas as pd
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
from selenium.common.exceptions import TimeoutException
import time

# ---------------- Setup ----------------
chrome_options = Options()
chrome_options.add_argument("--start-maximized")

service = Service(r"C:\Users\Lenovo\Downloads\chromedriver-win64 (1)\chromedriver-win64\chromedriver.exe")
driver = webdriver.Chrome(service=service, options=chrome_options)

driver.get("https://www.rewe.de/shop")
time.sleep(3)

# Click initial entry button
WebDriverWait(driver, 10).until(
    EC.element_to_be_clickable((By.ID, "intentionButtonList"))
).click()

# ---------------- Zip codes list ----------------

zip_codes = [
    "75449", "75447", "75989", "75988", "75987", "75986", "75985", "75984", "75983", "75982", "75981", "75980",
    "75979", "75978", "75977", "75976", "75975", "75974", "75973", "75972", "75971", "75970",
    "75969", "75968", "75967", "75966", "75965", "75964", "75963", "75962", "75961", "75960",
    "75959", "75958", "75957", "75956", "75955", "75954", "75953", "75952", "75951", "75950",
    "75949", "75948", "75947", "75946", "75945", "75944", "75943", "75942", "75941", "75940",
    "75939", "75938", "75937", "75936", "75935", "75934", "75933", "75932", "75931", "75930",
    "75929", "75928", "75927", "75926", "75925", "75924", "75923", "75922", "75921", "75920",
    "75919", "75918", "75917", "75916", "75915", "75914", "75913", "75912", "75911", "75910",
    "75909", "75908", "75907", "75906", "75905", "75904", "75903", "75902", "75901", "75900",
    "75899", "75898", "75897", "75896", "75895", "75894", "75893", "75892", "75891", "75890",
    "75889", "75888", "75887", "75886", "75885", "75884", "75883", "75882", "75881", "75880",
    "75879", "75878", "75877", "75876", "75875", "75874", "75873", "75872", "75871", "75870",
    "75869", "75868", "75867", "75866", "75865", "75864", "75863", "75862", "75861", "75860",
    "75859", "75858", "75857", "75856", "75855", "75854", "75853", "75852", "75851", "75850",
    "75849", "75848", "75847", "75846", "75845", "75844", "75843", "75842", "75841", "75840",
    "75839", "75838", "75837", "75836", "75835", "75834", "75833", "75832", "75831", "75830",
    "75829", "75828", "75827", "75826", "75825", "75824", "75823", "75822", "75821", "75820",
    "75819", "75818", "75817", "75816", "75815", "75814", "75813", "75812", "75811", "75810",
    "75809", "75808", "75807", "75806", "75805", "75804", "75803", "75802", "75801", "75800",
    "75799", "75798", "75797", "75796", "75795", "75794", "75793", "75792", "75791", "75790",
    "75789", "75788", "75787", "75786", "75785", "75784", "75783", "75782", "75781", "75780",
    "75779", "75778", "75777", "75776", "75775", "75774", "75773", "75772", "75771", "75770",
    "75769", "75768", "75767", "75766", "75765", "75764", "75763", "75762", "75761", "75760",
    "75759", "75758", "75757", "75756", "75755", "75754", "75753", "75752", "75751", "75750",
    "75749", "75748", "75747", "75746", "75745", "75744", "75743", "75742", "75741", "75740",
    "75739", "75738", "75737", "75736", "75735", "75734", "75733", "75732", "75731", "75730",
    "75729", "75728", "75727", "75726", "75725", "75724", "75723", "75722", "75721", "75720",
    "75719", "75718", "75717", "75716", "75715", "75714", "75713", "75712", "75711", "75710",
    "75709", "75708", "75707", "75706", "75705", "75704", "75703", "75702", "75701", "75700",
    "75699", "75698", "75697", "75696", "75695", "75694", "75693", "75692", "75691", "75690",
    "75689", "75688", "75687", "75686", "75685", "75684", "75683", "75682", "75681", "75680",
    "75679", "75678", "75677", "75676", "75675", "75674", "75673", "75672", "75671", "75670",
    "75669", "75668", "75667", "75666", "75665", "75664", "75663", "75662", "75661", "75660",
    "75659", "75658", "75657", "75656", "75655", "75654", "75653", "75652", "75651", "75650",
    "75649", "75648", "75647", "75646", "75645", "75644", "75643", "75642", "75641", "75640",
    "75639", "75638", "75637", "75636", "75635", "75634", "75633", "75632", "75631", "75630",
    "75629", "75628", "75627", "75626", "75625", "75624", "75623", "75622", "75621", "75620",
    "75619", "75618", "75617", "75616", "75615", "75614", "75613", "75612", "75611", "75610",
    "75609", "75608", "75607", "75606", "75605", "75604", "75603", "75602", "75601", "75600",
    "75599", "75598", "75597", "75596", "75595", "75594", "75593", "75592", "75591", "75590",
    "75589", "75588", "75587", "75586", "75585", "75584", "75583", "75582", "75581", "75580",
    "75579", "75578", "75577", "75576", "75575", "75574", "75573", "75572", "75571", "75570",
    "75569", "75568", "75567", "75566", "75565", "75564", "75563", "75562", "75561", "75560",
    "75559", "75558", "75557", "75556", "75555", "75554", "75553", "75552", "75551", "75550",
    "75549", "75548", "75547", "75546", "75545", "75544", "75543", "75542", "75541", "75540",
    "75539", "75538", "75537", "75536", "75535", "75534", "75533", "75532", "75531", "75530",
    "75529", "75528", "75527", "75526", "75525", "75524", "75523", "75522", "75521", "75520",
    "75519", "75518", "75517", "75516", "75515", "75514", "75513", "75512", "75511", "75510",
    "75509", "75508", "75507", "75506", "75505", "75504", "75503", "75502", "75501", "75500",
    "75499", "75498", "75497", "75496", "75495", "75494", "75493", "75492", "75491", "75490",
    "75489", "75488", "75487", "75486", "75485", "75484", "75483", "75482", "75481", "75480",
    "75479", "75478", "75477", "75476", "75475", "75474", "75473", "75472", "75471", "75470",
    "75469", "75468", "75467", "75466", "75465", "75464", "75463", "75462", "75461", "75460",
    "75459", "75458", "75457", "75456", "75455", "75454", "75453", "75452", "75451", "75450",
    "75448", "75446", "75445", "75444", "75443", "75442", "75441", "75440",
    "75439", "75438", "75437", "75436", "75435", "75434", "75433", "75432", "75431", "75430",
    "75429", "75428", "75427", "75426", "75425", "75424", "75423", "75422", "75421", "75420",
    "75419", "75418", "75417", "75416", "75415", "75414", "75413", "75412", "75411", "75410",
    "75409", "75408", "75407", "75406", "75405", "75404", "75403", "75402", "75401", "75400",
    "75399", "75398", "75397", "75396", "75395", "75394", "75393", "75392", "75391", "75390",
    "75389", "75388", "75387", "75386", "75385", "75384", "75383", "75382", "75381", "75380",
    "75379", "75378", "75377", "75376", "75375", "75374", "75373", "75372", "75371", "75370",
    "75369", "75368", "75367", "75366", "75365", "75364", "75363", "75362", "75361", "75360",
    "75359", "75358", "75357", "75356", "75355", "75354", "75353", "75352", "75351", "75350",
    "75349", "75348", "75347", "75346", "75345", "75344", "75343", "75342", "75341", "75340",
    "75339", "75338", "75337", "75336", "75335", "75334", "75333", "75332", "75331", "75330",
    "75329", "75328", "75327", "75326", "75325", "75324", "75323", "75322", "75321", "75320",
    "75319", "75318", "75317", "75316", "75315", "75314", "75313", "75312", "75311", "75310",
    "75309", "75308", "75307", "75306", "75305", "75304", "75303", "75302", "75301", "75300",
    "75299", "75298", "75297", "75296", "75295", "75294", "75293", "75292", "75291", "75290",
    "75289", "75288", "75287", "75286", "75285", "75284", "75283", "75282", "75281", "75280",
    "75279", "75278", "75277", "75276", "75275", "75274", "75273", "75272", "75271", "75270",
    "75269", "75268", "75267", "75266", "75265", "75264", "75263", "75262", "75261", "75260",
    "75259", "75258", "75257", "75256", "75255", "75254", "75253", "75252", "75251", "75250",
    "75249", "75248", "75247", "75246", "75245", "75244", "75243", "75242", "75241", "75240",
    "75239", "75238", "75237", "75236", "75235", "75234", "75233", "75232", "75231", "75230",
    "75229", "75228", "75227", "75226", "75225", "75224", "75223", "75222", "75221", "75220",
    "75219", "75218", "75217", "75216", "75215", "75214", "75213", "75212", "75211", "75210",
    "75209", "75208", "75207", "75206", "75205", "75204", "75203", "75202", "75201", "75200",
    "75199", "75198", "75197", "75196", "75195", "75194", "75193", "75192", "75191", "75190",
    "75189", "75188", "75187", "75186", "75185", "75184", "75183", "75182", "75181", "75180",
    "75179", "75178", "75177", "75176", "75175", "75174", "75173", "75172", "75171", "75170",
    "75169", "75168", "75167", "75166", "75165", "75164", "75163", "75162", "75161", "75160",
    "75159", "75158", "75157", "75156", "75155", "75154", "75153", "75152", "75151", "75150",
    "75149", "75148", "75147", "75146", "75145", "75144", "75143", "75142", "75141", "75140",
    "75139", "75138", "75137", "75136", "75135", "75134", "75133", "75132", "75131", "75130",
    "75129", "75128", "75127", "75126", "75125", "75124", "75123", "75122", "75121", "75120",
    "75119", "75118", "75117", "75116", "75115", "75114", "75113", "75112", "75111", "75110",
    "75109", "75108", "75107", "75106", "75105", "75104", "75103", "75102", "75101", "75100",
    "75099", "75098", "75097", "75096", "75095", "75094", "75093", "75092", "75091", "75090",
    "75089", "75088", "75087", "75086", "75085", "75084", "75083", "75082", "75081", "75080",
    "75079", "75078", "75077", "75076", "75075", "75074", "75073", "75072", "75071", "75070",
    "75069", "75068", "75067", "75066", "75065", "75064", "75063", "75062", "75061", "75060",
    "75059", "75058", "75057", "75056", "75055", "75054", "75053", "75052", "75051", "75050",
    "75049", "75048", "75047", "75046", "75045", "75044", "75043", "75042", "75041", "75040",
    "75039", "75038", "75037", "75036", "75035", "75034", "75033", "75032", "75031", "75030",
    "75029", "75028", "75027", "75026", "75025", "75024", "75023", "75022", "75021", "75020",
    "75019", "75018", "75017", "75016", "75015", "75014", "75013", "75012", "75011", "75010",
    "75009", "75008", "75007", "75006", "75005", "75004", "75003", "75002", "75001", "75000",
    "74999", "74998", "74997", "74996", "74995", "74994", "74993", "74992", "74991", "74990"
]



# Store results here
results = []

# ---------------- Loop through zip codes ----------------
for zc in zip_codes:
    try:
        print(f"\nProcessing zip code: {zc}")

        # Step 1: Enter zip code
        try:
            zip_input = WebDriverWait(driver, 5).until(
                EC.element_to_be_clickable((By.CLASS_NAME, "gbmc-zipcode-input"))
            )
            zip_input.clear()
            zip_input.send_keys(zc + Keys.ENTER)
        except TimeoutException:
            print("Zip input not available, maybe we're already in checkout flow.")

        time.sleep(2)

        # Step 2: Check for available buttons
        try:
            element = WebDriverWait(driver, 5).until(
                EC.any_of(
                    EC.presence_of_element_located((By.CLASS_NAME, "gbmc-back-button")),
                    EC.presence_of_element_located((By.CLASS_NAME, "gbmc-change-zipcode-link"))
                )
            )
            # ✅ If found → availability = Yes
            results.append({"zipcode": zc, "availability": "Yes"})

            # Re-find element to avoid stale reference
            element = driver.find_element(By.CLASS_NAME, element.get_attribute("class").split()[0])

            if "gbmc-back-button" in element.get_attribute("class"):
                print(f"Zip {zc} accepted -> back button present.")
                element.click()
            elif "gbmc-change-zipcode-link" in element.get_attribute("class"):
                print(f"Zip {zc} accepted -> change zip link present.")
                element.click()

        except TimeoutException:
            # ❌ If not found → availability = No
            print(f"Neither back nor change-zip buttons present for zip {zc}, marking as No...")
            results.append({"zipcode": zc, "availability": "No"})

            # Recovery flow
            try:
                headed_back = WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((By.CLASS_NAME, "gbmc-headed-back-button"))
                )
                headed_back.click()
                time.sleep(1)

                WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((By.ID, "intentionButtonList"))
                ).click()
                time.sleep(1)
                print(f"Recovered successfully for zip {zc}")

            except Exception:
                print(f"Recovery failed for zip {zc}")
                continue

    except Exception as e:
        print(f"Unexpected error with zip {zc}: {e}")
        results.append({"zipcode": zc, "availability": "No"})

time.sleep(5)
driver.quit()

# ---------------- Save results ----------------
df = pd.DataFrame(results)
df.to_csv("zipcode_availability26000.csv", index=False)
print("\n✅ Dataset saved as zip_availability.csv")

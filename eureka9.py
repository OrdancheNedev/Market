import pandas as pd
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
from selenium.common.exceptions import TimeoutException
import time

# ---------------- Setup ----------------
chrome_options = Options()
chrome_options.add_argument("--start-maximized")

service = Service(r"C:\Users\Lenovo\Downloads\chromedriver-win64 (1)\chromedriver-win64\chromedriver.exe")
driver = webdriver.Chrome(service=service, options=chrome_options)

driver.get("https://www.rewe.de/shop")
time.sleep(3)

# Click initial entry button
WebDriverWait(driver, 10).until(
    EC.element_to_be_clickable((By.ID, "intentionButtonList"))
).click()

# ---------------- Zip codes list ----------------

zip_codes = numbers = [
"66894","66892","66989","66988","66987","66986","66985","66984","66983","66982","66981","66980",
"66979","66978","66977","66976","66975","66974","66973","66972","66971","66970",
"66969","66968","66967","66966","66965","66964","66963","66962","66961","66960",
"66959","66958","66957","66956","66955","66954","66953","66952","66951","66950",
"66949","66948","66947","66946","66945","66944","66943","66942","66941","66940",
"66939","66938","66937","66936","66935","66934","66933","66932","66931","66930",
"66929","66928","66927","66926","66925","66924","66923","66922","66921","66920",
"66919","66918","66917","66916","66915","66914","66913","66912","66911","66910",
"66909","66908","66907","66906","66905","66904","66903","66902","66901","66900",
"66899","66898","66897","66896","66895","66894","66893","66892","66891","66890",
"66889","66888","66887","66886","66885","66884","66883","66882","66881","66880",
"66879","66878","66877","66876","66875","66874","66873","66872","66871","66870",
"66869","66868","66867","66866","66865","66864","66863","66862","66861","66860",
"66859","66858","66857","66856","66855","66854","66853","66852","66851","66850",
"66849","66848","66847","66846","66845","66844","66843","66842","66841","66840",
"66839","66838","66837","66836","66835","66834","66833","66832","66831","66830",
"66829","66828","66827","66826","66825","66824","66823","66822","66821","66820",
"66819","66818","66817","66816","66815","66814","66813","66812","66811","66810",
"66809","66808","66807","66806","66805","66804","66803","66802","66801","66800",
"66799","66798","66797","66796","66795","66794","66793","66792","66791","66790",
"66789","66788","66787","66786","66785","66784","66783","66782","66781","66780",
"66779","66778","66777","66776","66775","66774","66773","66772","66771","66770",
"66769","66768","66767","66766","66765","66764","66763","66762","66761","66760",
"66759","66758","66757","66756","66755","66754","66753","66752","66751","66750",
"66749","66748","66747","66746","66745","66744","66743","66742","66741","66740",
"66739","66738","66737","66736","66735","66734","66733","66732","66731","66730",
"66729","66728","66727","66726","66725","66724","66723","66722","66721","66720",
"66719","66718","66717","66716","66715","66714","66713","66712","66711","66710",
"66709","66708","66707","66706","66705","66704","66703","66702","66701","66700",
"66699","66698","66697","66696","66695","66694","66693","66692","66691","66690",
"66689","66688","66687","66686","66685","66684","66683","66682","66681","66680",
"66679","66678","66677","66676","66675","66674","66673","66672","66671","66670",
"66669","66668","66667","66666","66665","66664","66663","66662","66661","66660",
"66659","66658","66657","66656","66655","66654","66653","66652","66651","66650",
"66649","66648","66647","66646","66645","66644","66643","66642","66641","66640",
"66639","66638","66637","66636","66635","66634","66633","66632","66631","66630",
"66629","66628","66627","66626","66625","66624","66623","66622","66621","66620",
"66619","66618","66617","66616","66615","66614","66613","66612","66611","66610",
"66609","66608","66607","66606","66605","66604","66603","66602","66601","66600",
"66599","66598","66597","66596","66595","66594","66593","66592","66591","66590",
"66589","66588","66587","66586","66585","66584","66583","66582","66581","66580",
"66579","66578","66577","66576","66575","66574","66573","66572","66571","66570",
"66569","66568","66567","66566","66565","66564","66563","66562","66561","66560",
"66559","66558","66557","66556","66555","66554","66553","66552","66551","66550",
"66549","66548","66547","66546","66545","66544","66543","66542","66541","66540",
"66539","66538","66537","66536","66535","66534","66533","66532","66531","66530",
"66529","66528","66527","66526","66525","66524","66523","66522","66521","66520",
"66519","66518","66517","66516","66515","66514","66513","66512","66511","66510",
"66509","66508","66507","66506","66505","66504","66503","66502","66501","66500",
"66499","66498","66497","66496","66495","66494","66493","66492","66491","66490",
"66489","66488","66487","66486","66485","66484","66483","66482","66481","66480",
"66479","66478","66477","66476","66475","66474","66473","66472","66471","66470",
"66469","66468","66467","66466","66465","66464","66463","66462","66461","66460",
"66459","66458","66457","66456","66455","66454","66453","66452","66451","66450",
"66449","66448","66447","66446","66445","66444","66443","66442","66441","66440",
"66439","66438","66437","66436","66435","66434","66433","66432","66431","66430",
"66429","66428","66427","66426","66425","66424","66423","66422","66421","66420",
"66419","66418","66417","66416","66415","66414","66413","66412","66411","66410",
"66409","66408","66407","66406","66405","66404","66403","66402","66401","66400",
"66399","66398","66397","66396","66395","66394","66393","66392","66391","66390",
"66389","66388","66387","66386","66385","66384","66383","66382","66381","66380",
"66379","66378","66377","66376","66375","66374","66373","66372","66371","66370",
"66369","66368","66367","66366","66365","66364","66363","66362","66361","66360",
"66359","66358","66357","66356","66355","66354","66353","66352","66351","66350",
"66349","66348","66347","66346","66345","66344","66343","66342","66341","66340",
"66339","66338","66337","66336","66335","66334","66333","66332","66331","66330",
"66329","66328","66327","66326","66325","66324","66323","66322","66321","66320",
"66319","66318","66317","66316","66315","66314","66313","66312","66311","66310",
"66309","66308","66307","66306","66305","66304","66303","66302","66301","66300",
"66299","66298","66297","66296","66295","66294","66293","66292","66291","66290",
"66289","66288","66287","66286","66285","66284","66283","66282","66281","66280",
"66279","66278","66277","66276","66275","66274","66273","66272","66271","66270",
"66269","66268","66267","66266","66265","66264","66263","66262","66261","66260",
"66259","66258","66257","66256","66255","66254","66253","66252","66251","66250",
"66249","66248","66247","66246","66245","66244","66243","66242","66241","66240",
"66239","66238","66237","66236","66235","66234","66233","66232","66231","66230",
"66229","66228","66227","66226","66225","66224","66223","66222","66221","66220",
"66219","66218","66217","66216","66215","66214","66213","66212","66211","66210",
"66209","66208","66207","66206","66205","66204","66203","66202","66201","66200",
"66199","66198","66197","66196","66195","66194","66193","66192","66191","66190",
"66189","66188","66187","66186","66185","66184","66183","66182","66181","66180",
"66179","66178","66177","66176","66175","66174","66173","66172","66171","66170",
"66169","66168","66167","66166","66165","66164","66163","66162","66161","66160",
"66159","66158","66157","66156","66155","66154","66153","66152","66151","66150",
"66149","66148","66147","66146","66145","66144","66143","66142","66141","66140",
"66139","66138","66137","66136","66135","66134","66133","66132","66131","66130",
"66129","66128","66127","66126","66125","66124","66123","66122","66121","66120",
"66119","66118","66117","66116","66115","66114","66113","66112","66111","66110",
"66109","66108","66107","66106","66105","66104","66103","66102","66101","66100",
"66099","66098","66097","66096","66095","66094","66093","66092","66091","66090",
"66089","66088","66087","66086","66085","66084","66083","66082","66081","66080",
"66079","66078","66077","66076","66075","66074","66073","66072","66071","66070",
"66069","66068","66067","66066","66065","66064","66063","66062","66061","66060",
"66059","66058","66057","66056","66055","66054","66053","66052","66051","66050",
"66049","66048","66047","66046","66045","66044","66043","66042","66041","66040",
"66039","66038","66037","66036","66035","66034","66033","66032","66031","66030",
"66029","66028","66027","66026","66025","66024","66023","66022","66021","66020",
"66019","66018","66017","66016","66015","66014","66013","66012","66011","66010",
"66009","66008","66007","66006","66005","66004","66003","66002","66001","66000",
"65999","65998","65997","65996","65995","65994","65993","65992","65991","65990"
]



# Store results here
results = []

# ---------------- Loop through zip codes ----------------
for zc in zip_codes:
    try:
        print(f"\nProcessing zip code: {zc}")

        # Step 1: Enter zip code
        try:
            zip_input = WebDriverWait(driver, 5).until(
                EC.element_to_be_clickable((By.CLASS_NAME, "gbmc-zipcode-input"))
            )
            zip_input.clear()
            zip_input.send_keys(zc + Keys.ENTER)
        except TimeoutException:
            print("Zip input not available, maybe we're already in checkout flow.")

        time.sleep(2)

        # Step 2: Check for available buttons
        try:
            element = WebDriverWait(driver, 5).until(
                EC.any_of(
                    EC.presence_of_element_located((By.CLASS_NAME, "gbmc-back-button")),
                    EC.presence_of_element_located((By.CLASS_NAME, "gbmc-change-zipcode-link"))
                )
            )
            # ✅ If found → availability = Yes
            results.append({"zipcode": zc, "availability": "Yes"})

            # Re-find element to avoid stale reference
            element = driver.find_element(By.CLASS_NAME, element.get_attribute("class").split()[0])

            if "gbmc-back-button" in element.get_attribute("class"):
                print(f"Zip {zc} accepted -> back button present.")
                element.click()
            elif "gbmc-change-zipcode-link" in element.get_attribute("class"):
                print(f"Zip {zc} accepted -> change zip link present.")
                element.click()

        except TimeoutException:
            # ❌ If not found → availability = No
            print(f"Neither back nor change-zip buttons present for zip {zc}, marking as No...")
            results.append({"zipcode": zc, "availability": "No"})

            # Recovery flow
            try:
                headed_back = WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((By.CLASS_NAME, "gbmc-headed-back-button"))
                )
                headed_back.click()
                time.sleep(1)

                WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((By.ID, "intentionButtonList"))
                ).click()
                time.sleep(1)
                print(f"Recovered successfully for zip {zc}")

            except Exception:
                print(f"Recovery failed for zip {zc}")
                continue

    except Exception as e:
        print(f"Unexpected error with zip {zc}: {e}")
        results.append({"zipcode": zc, "availability": "No"})

time.sleep(5)
driver.quit()

# ---------------- Save results ----------------
df = pd.DataFrame(results)
df.to_csv("zipcode_availability35000.csv", index=False)
print("\n✅ Dataset saved as zip_availability.csv")

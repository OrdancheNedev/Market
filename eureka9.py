import pandas as pd
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
from selenium.common.exceptions import TimeoutException
import time

# ---------------- Setup ----------------
chrome_options = Options()
chrome_options.add_argument("--start-maximized")

service = Service(r"C:\Users\Lenovo\Downloads\chromedriver-win64 (1)\chromedriver-win64\chromedriver.exe")
driver = webdriver.Chrome(service=service, options=chrome_options)

driver.get("https://www.rewe.de/shop")
time.sleep(3)

# Click initial entry button
WebDriverWait(driver, 10).until(
    EC.element_to_be_clickable((By.ID, "intentionButtonList"))
).click()

# ---------------- Zip codes list ----------------

zip_codes = [
"79879","79877","79989","79988","79987","79986","79985","79984","79983","79982","79981","79980",
"79979","79978","79977","79976","79975","79974","79973","79972","79971","79970",
"79969","79968","79967","79966","79965","79964","79963","79962","79961","79960",
"79959","79958","79957","79956","79955","79954","79953","79952","79951","79950",
"79949","79948","79947","79946","79945","79944","79943","79942","79941","79940",
"79939","79938","79937","79936","79935","79934","79933","79932","79931","79930",
"79929","79928","79927","79926","79925","79924","79923","79922","79921","79920",
"79919","79918","79917","79916","79915","79914","79913","79912","79911","79910",
"79909","79908","79907","79906","79905","79904","79903","79902","79901","79900",
"79899","79898","79897","79896","79895","79894","79893","79892","79891","79890",
"79889","79888","79887","79886","79885","79884","79883","79882","79881","79880",
"79878","79876","79875","79874","79873","79872","79871","79870",
"79869","79868","79867","79866","79865","79864","79863","79862","79861","79860",
"79859","79858","79857","79856","79855","79854","79853","79852","79851","79850",
"79849","79848","79847","79846","79845","79844","79843","79842","79841","79840",
"79839","79838","79837","79836","79835","79834","79833","79832","79831","79830",
"79829","79828","79827","79826","79825","79824","79823","79822","79821","79820",
"79819","79818","79817","79816","79815","79814","79813","79812","79811","79810",
"79809","79808","79807","79806","79805","79804","79803","79802","79801","79800",
"79799","79798","79797","79796","79795","79794","79793","79792","79791","79790",
"79789","79788","79787","79786","79785","79784","79783","79782","79781","79780",
"79779","79778","79777","79776","79775","79774","79773","79772","79771","79770",
"79769","79768","79767","79766","79765","79764","79763","79762","79761","79760",
"79759","79758","79757","79756","79755","79754","79753","79752","79751","79750",
"79749","79748","79747","79746","79745","79744","79743","79742","79741","79740",
"79739","79738","79737","79736","79735","79734","79733","79732","79731","79730",
"79729","79728","79727","79726","79725","79724","79723","79722","79721","79720",
"79719","79718","79717","79716","79715","79714","79713","79712","79711","79710",
"79709","79708","79707","79706","79705","79704","79703","79702","79701","79700",
"79699","79698","79697","79696","79695","79694","79693","79692","79691","79690",
"79689","79688","79687","79686","79685","79684","79683","79682","79681","79680",
"79679","79678","79677","79676","79675","79674","79673","79672","79671","79670",
"79669","79668","79667","79666","79665","79664","79663","79662","79661","79660",
"79659","79658","79657","79656","79655","79654","79653","79652","79651","79650",
"79649","79648","79647","79646","79645","79644","79643","79642","79641","79640",
"79639","79638","79637","79636","79635","79634","79633","79632","79631","79630",
"79629","79628","79627","79626","79625","79624","79623","79622","79621","79620",
"79619","79618","79617","79616","79615","79614","79613","79612","79611","79610",
"79609","79608","79607","79606","79605","79604","79603","79602","79601","79600",
"79599","79598","79597","79596","79595","79594","79593","79592","79591","79590",
"79589","79588","79587","79586","79585","79584","79583","79582","79581","79580",
"79579","79578","79577","79576","79575","79574","79573","79572","79571","79570",
"79569","79568","79567","79566","79565","79564","79563","79562","79561","79560",
"79559","79558","79557","79556","79555","79554","79553","79552","79551","79550",
"79549","79548","79547","79546","79545","79544","79543","79542","79541","79540",
"79539","79538","79537","79536","79535","79534","79533","79532","79531","79530",
"79529","79528","79527","79526","79525","79524","79523","79522","79521","79520",
"79519","79518","79517","79516","79515","79514","79513","79512","79511","79510",
"79509","79508","79507","79506","79505","79504","79503","79502","79501","79500",
"79499","79498","79497","79496","79495","79494","79493","79492","79491","79490",
"79489","79488","79487","79486","79485","79484","79483","79482","79481","79480",
"79479","79478","79477","79476","79475","79474","79473","79472","79471","79470",
"79469","79468","79467","79466","79465","79464","79463","79462","79461","79460",
"79459","79458","79457","79456","79455","79454","79453","79452","79451","79450",
"79449","79448","79447","79446","79445","79444","79443","79442","79441","79440",
"79439","79438","79437","79436","79435","79434","79433","79432","79431","79430",
"79429","79428","79427","79426","79425","79424","79423","79422","79421","79420",
"79419","79418","79417","79416","79415","79414","79413","79412","79411","79410",
"79409","79408","79407","79406","79405","79404","79403","79402","79401","79400",
"79399","79398","79397","79396","79395","79394","79393","79392","79391","79390",
"79389","79388","79387","79386","79385","79384","79383","79382","79381","79380",
"79379","79378","79377","79376","79375","79374","79373","79372","79371","79370",
"79369","79368","79367","79366","79365","79364","79363","79362","79361","79360",
"79359","79358","79357","79356","79355","79354","79353","79352","79351","79350",
"79349","79348","79347","79346","79345","79344","79343","79342","79341","79340",
"79339","79338","79337","79336","79335","79334","79333","79332","79331","79330",
"79329","79328","79327","79326","79325","79324","79323","79322","79321","79320",
"79319","79318","79317","79316","79315","79314","79313","79312","79311","79310",
"79309","79308","79307","79306","79305","79304","79303","79302","79301","79300",
"79299","79298","79297","79296","79295","79294","79293","79292","79291","79290",
"79289","79288","79287","79286","79285","79284","79283","79282","79281","79280",
"79279","79278","79277","79276","79275","79274","79273","79272","79271","79270",
"79269","79268","79267","79266","79265","79264","79263","79262","79261","79260",
"79259","79258","79257","79256","79255","79254","79253","79252","79251","79250",
"79249","79248","79247","79246","79245","79244","79243","79242","79241","79240",
"79239","79238","79237","79236","79235","79234","79233","79232","79231","79230",
"79229","79228","79227","79226","79225","79224","79223","79222","79221","79220",
"79219","79218","79217","79216","79215","79214","79213","79212","79211","79210",
"79209","79208","79207","79206","79205","79204","79203","79202","79201","79200",
"79199","79198","79197","79196","79195","79194","79193","79192","79191","79190",
"79189","79188","79187","79186","79185","79184","79183","79182","79181","79180",
"79179","79178","79177","79176","79175","79174","79173","79172","79171","79170",
"79169","79168","79167","79166","79165","79164","79163","79162","79161","79160",
"79159","79158","79157","79156","79155","79154","79153","79152","79151","79150",
"79149","79148","79147","79146","79145","79144","79143","79142","79141","79140",
"79139","79138","79137","79136","79135","79134","79133","79132","79131","79130",
"79129","79128","79127","79126","79125","79124","79123","79122","79121","79120",
"79119","79118","79117","79116","79115","79114","79113","79112","79111","79110",
"79109","79108","79107","79106","79105","79104","79103","79102","79101","79100",
"79099","79098","79097","79096","79095","79094","79093","79092","79091","79090",
"79089","79088","79087","79086","79085","79084","79083","79082","79081","79080",
"79079","79078","79077","79076","79075","79074","79073","79072","79071","79070",
"79069","79068","79067","79066","79065","79064","79063","79062","79061","79060",
"79059","79058","79057","79056","79055","79054","79053","79052","79051","79050",
"79049","79048","79047","79046","79045","79044","79043","79042","79041","79040",
"79039","79038","79037","79036","79035","79034","79033","79032","79031","79030",
"79029","79028","79027","79026","79025","79024","79023","79022","79021","79020",
"79019","79018","79017","79016","79015","79014","79013","79012","79011","79010",
"79009","79008","79007","79006","79005","79004","79003","79002","79001","79000",
"78999","78998","78997","78996","78995","78994","78993","78992","78991","78990"
]



# Store results here
results = []

# ---------------- Loop through zip codes ----------------
for zc in zip_codes:
    try:
        print(f"\nProcessing zip code: {zc}")

        # Step 1: Enter zip code
        try:
            zip_input = WebDriverWait(driver, 5).until(
                EC.element_to_be_clickable((By.CLASS_NAME, "gbmc-zipcode-input"))
            )
            zip_input.clear()
            zip_input.send_keys(zc + Keys.ENTER)
        except TimeoutException:
            print("Zip input not available, maybe we're already in checkout flow.")

        time.sleep(2)

        # Step 2: Check for available buttons
        try:
            element = WebDriverWait(driver, 5).until(
                EC.any_of(
                    EC.presence_of_element_located((By.CLASS_NAME, "gbmc-back-button")),
                    EC.presence_of_element_located((By.CLASS_NAME, "gbmc-change-zipcode-link"))
                )
            )
            # ✅ If found → availability = Yes
            results.append({"zipcode": zc, "availability": "Yes"})

            # Re-find element to avoid stale reference
            element = driver.find_element(By.CLASS_NAME, element.get_attribute("class").split()[0])

            if "gbmc-back-button" in element.get_attribute("class"):
                print(f"Zip {zc} accepted -> back button present.")
                element.click()
            elif "gbmc-change-zipcode-link" in element.get_attribute("class"):
                print(f"Zip {zc} accepted -> change zip link present.")
                element.click()

        except TimeoutException:
            # ❌ If not found → availability = No
            print(f"Neither back nor change-zip buttons present for zip {zc}, marking as No...")
            results.append({"zipcode": zc, "availability": "No"})

            # Recovery flow
            try:
                headed_back = WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((By.CLASS_NAME, "gbmc-headed-back-button"))
                )
                headed_back.click()
                time.sleep(1)

                WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((By.ID, "intentionButtonList"))
                ).click()
                time.sleep(1)
                print(f"Recovered successfully for zip {zc}")

            except Exception:
                print(f"Recovery failed for zip {zc}")
                continue

    except Exception as e:
        print(f"Unexpected error with zip {zc}: {e}")
        results.append({"zipcode": zc, "availability": "No"})

time.sleep(5)
driver.quit()

# ---------------- Save results ----------------
df = pd.DataFrame(results)
df.to_csv("zipcode_availability23000.csv", index=False)
print("\n✅ Dataset saved as zip_availability.csv")

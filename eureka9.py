import pandas as pd
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
from selenium.common.exceptions import TimeoutException
import time

# ---------------- Setup ----------------
chrome_options = Options()
chrome_options.add_argument("--start-maximized")

service = Service(r"C:\Users\Lenovo\Downloads\chromedriver-win64 (1)\chromedriver-win64\chromedriver.exe")
driver = webdriver.Chrome(service=service, options=chrome_options)

driver.get("https://www.rewe.de/shop")
time.sleep(3)

# Click initial entry button
WebDriverWait(driver, 10).until(
    EC.element_to_be_clickable((By.ID, "intentionButtonList"))
).click()

# ---------------- Zip codes list ----------------
zip_codes = [
"72829","72827","72989","72988","72987","72986","72985","72984","72983","72982","72981","72980",
"72979","72978","72977","72976","72975","72974","72973","72972","72971","72970",
"72969","72968","72967","72966","72965","72964","72963","72962","72961","72960",
"72959","72958","72957","72956","72955","72954","72953","72952","72951","72950",
"72949","72948","72947","72946","72945","72944","72943","72942","72941","72940",
"72939","72938","72937","72936","72935","72934","72933","72932","72931","72930",
"72929","72928","72927","72926","72925","72924","72923","72922","72921","72920",
"72919","72918","72917","72916","72915","72914","72913","72912","72911","72910",
"72909","72908","72907","72906","72905","72904","72903","72902","72901","72900",
"72899","72898","72897","72896","72895","72894","72893","72892","72891","72890",
"72889","72888","72887","72886","72885","72884","72883","72882","72881","72880",
"72879","72878","72877","72876","72875","72874","72873","72872","72871","72870",
"72869","72868","72867","72866","72865","72864","72863","72862","72861","72860",
"72859","72858","72857","72856","72855","72854","72853","72852","72851","72850",
"72849","72848","72847","72846","72845","72844","72843","72842","72841","72840",
"72839","72838","72837","72836","72835","72834","72833","72832","72831","72830",
"72828","72826","72825","72824","72823","72822","72821","72820",
"72819","72818","72817","72816","72815","72814","72813","72812","72811","72810",
"72809","72808","72807","72806","72805","72804","72803","72802","72801","72800",
"72799","72798","72797","72796","72795","72794","72793","72792","72791","72790",
"72789","72788","72787","72786","72785","72784","72783","72782","72781","72780",
"72779","72778","72777","72776","72775","72774","72773","72772","72771","72770",
"72769","72768","72767","72766","72765","72764","72763","72762","72761","72760",
"72759","72758","72757","72756","72755","72754","72753","72752","72751","72750",
"72749","72748","72747","72746","72745","72744","72743","72742","72741","72740",
"72739","72738","72737","72736","72735","72734","72733","72732","72731","72730",
"72729","72728","72727","72726","72725","72724","72723","72722","72721","72720",
"72719","72718","72717","72716","72715","72714","72713","72712","72711","72710",
"72709","72708","72707","72706","72705","72704","72703","72702","72701","72700",
"72699","72698","72697","72696","72695","72694","72693","72692","72691","72690",
"72689","72688","72687","72686","72685","72684","72683","72682","72681","72680",
"72679","72678","72677","72676","72675","72674","72673","72672","72671","72670",
"72669","72668","72667","72666","72665","72664","72663","72662","72661","72660",
"72659","72658","72657","72656","72655","72654","72653","72652","72651","72650",
"72649","72648","72647","72646","72645","72644","72643","72642","72641","72640",
"72639","72638","72637","72636","72635","72634","72633","72632","72631","72630",
"72629","72628","72627","72626","72625","72624","72623","72622","72621","72620",
"72619","72618","72617","72616","72615","72614","72613","72612","72611","72610",
"72609","72608","72607","72606","72605","72604","72603","72602","72601","72600",
"72599","72598","72597","72596","72595","72594","72593","72592","72591","72590",
"72589","72588","72587","72586","72585","72584","72583","72582","72581","72580",
"72579","72578","72577","72576","72575","72574","72573","72572","72571","72570",
"72569","72568","72567","72566","72565","72564","72563","72562","72561","72560",
"72559","72558","72557","72556","72555","72554","72553","72552","72551","72550",
"72549","72548","72547","72546","72545","72544","72543","72542","72541","72540",
"72539","72538","72537","72536","72535","72534","72533","72532","72531","72530",
"72529","72528","72527","72526","72525","72524","72523","72522","72521","72520",
"72519","72518","72517","72516","72515","72514","72513","72512","72511","72510",
"72509","72508","72507","72506","72505","72504","72503","72502","72501","72500",
"72499","72498","72497","72496","72495","72494","72493","72492","72491","72490",
"72489","72488","72487","72486","72485","72484","72483","72482","72481","72480",
"72479","72478","72477","72476","72475","72474","72473","72472","72471","72470",
"72469","72468","72467","72466","72465","72464","72463","72462","72461","72460",
"72459","72458","72457","72456","72455","72454","72453","72452","72451","72450",
"72449","72448","72447","72446","72445","72444","72443","72442","72441","72440",
"72439","72438","72437","72436","72435","72434","72433","72432","72431","72430",
"72429","72428","72427","72426","72425","72424","72423","72422","72421","72420",
"72419","72418","72417","72416","72415","72414","72413","72412","72411","72410",
"72409","72408","72407","72406","72405","72404","72403","72402","72401","72400",
"72399","72398","72397","72396","72395","72394","72393","72392","72391","72390",
"72389","72388","72387","72386","72385","72384","72383","72382","72381","72380",
"72379","72378","72377","72376","72375","72374","72373","72372","72371","72370",
"72369","72368","72367","72366","72365","72364","72363","72362","72361","72360",
"72359","72358","72357","72356","72355","72354","72353","72352","72351","72350",
"72349","72348","72347","72346","72345","72344","72343","72342","72341","72340",
"72339","72338","72337","72336","72335","72334","72333","72332","72331","72330",
"72329","72328","72327","72326","72325","72324","72323","72322","72321","72320",
"72319","72318","72317","72316","72315","72314","72313","72312","72311","72310",
"72309","72308","72307","72306","72305","72304","72303","72302","72301","72300",
"72299","72298","72297","72296","72295","72294","72293","72292","72291","72290",
"72289","72288","72287","72286","72285","72284","72283","72282","72281","72280",
"72279","72278","72277","72276","72275","72274","72273","72272","72271","72270",
"72269","72268","72267","72266","72265","72264","72263","72262","72261","72260",
"72259","72258","72257","72256","72255","72254","72253","72252","72251","72250",
"72249","72248","72247","72246","72245","72244","72243","72242","72241","72240",
"72239","72238","72237","72236","72235","72234","72233","72232","72231","72230",
"72229","72228","72227","72226","72225","72224","72223","72222","72221","72220",
"72219","72218","72217","72216","72215","72214","72213","72212","72211","72210",
"72209","72208","72207","72206","72205","72204","72203","72202","72201","72200",
"72199","72198","72197","72196","72195","72194","72193","72192","72191","72190",
"72189","72188","72187","72186","72185","72184","72183","72182","72181","72180",
"72179","72178","72177","72176","72175","72174","72173","72172","72171","72170",
"72169","72168","72167","72166","72165","72164","72163","72162","72161","72160",
"72159","72158","72157","72156","72155","72154","72153","72152","72151","72150",
"72149","72148","72147","72146","72145","72144","72143","72142","72141","72140",
"72139","72138","72137","72136","72135","72134","72133","72132","72131","72130",
"72129","72128","72127","72126","72125","72124","72123","72122","72121","72120",
"72119","72118","72117","72116","72115","72114","72113","72112","72111","72110",
"72109","72108","72107","72106","72105","72104","72103","72102","72101","72100",
"72099","72098","72097","72096","72095","72094","72093","72092","72091","72090",
"72089","72088","72087","72086","72085","72084","72083","72082","72081","72080",
"72079","72078","72077","72076","72075","72074","72073","72072","72071","72070",
"72069","72068","72067","72066","72065","72064","72063","72062","72061","72060",
"72059","72058","72057","72056","72055","72054","72053","72052","72051","72050",
"72049","72048","72047","72046","72045","72044","72043","72042","72041","72040",
"72039","72038","72037","72036","72035","72034","72033","72032","72031","72030",
"72029","72028","72027","72026","72025","72024","72023","72022","72021","72020",
"72019","72018","72017","72016","72015","72014","72013","72012","72011","72010",
"72009","72008","72007","72006","72005","72004","72003","72002","72001","72000",
"71999","71998","71997","71996","71995","71994","71993","71992","71991","71990"
]


# Store results here
results = []

# ---------------- Loop through zip codes ----------------
for zc in zip_codes:
    try:
        print(f"\nProcessing zip code: {zc}")

        # Step 1: Enter zip code
        try:
            zip_input = WebDriverWait(driver, 5).until(
                EC.element_to_be_clickable((By.CLASS_NAME, "gbmc-zipcode-input"))
            )
            zip_input.clear()
            zip_input.send_keys(zc + Keys.ENTER)
        except TimeoutException:
            print("Zip input not available, maybe we're already in checkout flow.")

        time.sleep(2)

        # Step 2: Check for available buttons
        try:
            element = WebDriverWait(driver, 5).until(
                EC.any_of(
                    EC.presence_of_element_located((By.CLASS_NAME, "gbmc-back-button")),
                    EC.presence_of_element_located((By.CLASS_NAME, "gbmc-change-zipcode-link"))
                )
            )
            # ✅ If found → availability = Yes
            results.append({"zipcode": zc, "availability": "Yes"})

            # Re-find element to avoid stale reference
            element = driver.find_element(By.CLASS_NAME, element.get_attribute("class").split()[0])

            if "gbmc-back-button" in element.get_attribute("class"):
                print(f"Zip {zc} accepted -> back button present.")
                element.click()
            elif "gbmc-change-zipcode-link" in element.get_attribute("class"):
                print(f"Zip {zc} accepted -> change zip link present.")
                element.click()

        except TimeoutException:
            # ❌ If not found → availability = No
            print(f"Neither back nor change-zip buttons present for zip {zc}, marking as No...")
            results.append({"zipcode": zc, "availability": "No"})

            # Recovery flow
            try:
                headed_back = WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((By.CLASS_NAME, "gbmc-headed-back-button"))
                )
                headed_back.click()
                time.sleep(1)

                WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((By.ID, "intentionButtonList"))
                ).click()
                time.sleep(1)
                print(f"Recovered successfully for zip {zc}")

            except Exception:
                print(f"Recovery failed for zip {zc}")
                continue

    except Exception as e:
        print(f"Unexpected error with zip {zc}: {e}")
        results.append({"zipcode": zc, "availability": "No"})

time.sleep(5)
driver.quit()

# ---------------- Save results ----------------
df = pd.DataFrame(results)
df.to_csv("zipcode_availability29000.csv", index=False)
print("\n✅ Dataset saved as zip_availability.csv")

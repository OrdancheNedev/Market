import pandas as pd
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
from selenium.common.exceptions import TimeoutException
import time

# ---------------- Setup ----------------
chrome_options = Options()
chrome_options.add_argument("--start-maximized")

service = Service(r"C:\Users\Lenovo\Downloads\chromedriver-win64 (1)\chromedriver-win64\chromedriver.exe")
driver = webdriver.Chrome(service=service, options=chrome_options)

driver.get("https://www.rewe.de/shop")
time.sleep(3)

# Click initial entry button
WebDriverWait(driver, 10).until(
    EC.element_to_be_clickable((By.ID, "intentionButtonList"))
).click()

# ---------------- Zip codes list ----------------

zip_codes = [
'77978','77977','77989','77988','77987','77986','77985','77984','77983','77982','77981','77980',
'77979','77976','77975','77974','77973','77972','77971','77970',
'77969','77968','77967','77966','77965','77964','77963','77962','77961','77960',
'77959','77958','77957','77956','77955','77954','77953','77952','77951','77950',
'77949','77948','77947','77946','77945','77944','77943','77942','77941','77940',
'77939','77938','77937','77936','77935','77934','77933','77932','77931','77930',
'77929','77928','77927','77926','77925','77924','77923','77922','77921','77920',
'77919','77918','77917','77916','77915','77914','77913','77912','77911','77910',
'77909','77908','77907','77906','77905','77904','77903','77902','77901','77900',
'77899','77898','77897','77896','77895','77894','77893','77892','77891','77890',
'77889','77888','77887','77886','77885','77884','77883','77882','77881','77880',
'77879','77878','77877','77876','77875','77874','77873','77872','77871','77870',
'77869','77868','77867','77866','77865','77864','77863','77862','77861','77860',
'77859','77858','77857','77856','77855','77854','77853','77852','77851','77850',
'77849','77848','77847','77846','77845','77844','77843','77842','77841','77840',
'77839','77838','77837','77836','77835','77834','77833','77832','77831','77830',
'77829','77828','77827','77826','77825','77824','77823','77822','77821','77820',
'77819','77818','77817','77816','77815','77814','77813','77812','77811','77810',
'77809','77808','77807','77806','77805','77804','77803','77802','77801','77800',
'77799','77798','77797','77796','77795','77794','77793','77792','77791','77790',
'77789','77788','77787','77786','77785','77784','77783','77782','77781','77780',
'77779','77778','77777','77776','77775','77774','77773','77772','77771','77770',
'77769','77768','77767','77766','77765','77764','77763','77762','77761','77760',
'77759','77758','77757','77756','77755','77754','77753','77752','77751','77750',
'77749','77748','77747','77746','77745','77744','77743','77742','77741','77740',
'77739','77738','77737','77736','77735','77734','77733','77732','77731','77730',
'77729','77728','77727','77726','77725','77724','77723','77722','77721','77720',
'77719','77718','77717','77716','77715','77714','77713','77712','77711','77710',
'77709','77708','77707','77706','77705','77704','77703','77702','77701','77700',
'77699','77698','77697','77696','77695','77694','77693','77692','77691','77690',
'77689','77688','77687','77686','77685','77684','77683','77682','77681','77680',
'77679','77678','77677','77676','77675','77674','77673','77672','77671','77670',
'77669','77668','77667','77666','77665','77664','77663','77662','77661','77660',
'77659','77658','77657','77656','77655','77654','77653','77652','77651','77650',
'77649','77648','77647','77646','77645','77644','77643','77642','77641','77640',
'77639','77638','77637','77636','77635','77634','77633','77632','77631','77630',
'77629','77628','77627','77626','77625','77624','77623','77622','77621','77620',
'77619','77618','77617','77616','77615','77614','77613','77612','77611','77610',
'77609','77608','77607','77606','77605','77604','77603','77602','77601','77600',
'77599','77598','77597','77596','77595','77594','77593','77592','77591','77590',
'77589','77588','77587','77586','77585','77584','77583','77582','77581','77580',
'77579','77578','77577','77576','77575','77574','77573','77572','77571','77570',
'77569','77568','77567','77566','77565','77564','77563','77562','77561','77560',
'77559','77558','77557','77556','77555','77554','77553','77552','77551','77550',
'77549','77548','77547','77546','77545','77544','77543','77542','77541','77540',
'77539','77538','77537','77536','77535','77534','77533','77532','77531','77530',
'77529','77528','77527','77526','77525','77524','77523','77522','77521','77520',
'77519','77518','77517','77516','77515','77514','77513','77512','77511','77510',
'77509','77508','77507','77506','77505','77504','77503','77502','77501','77500',
'77499','77498','77497','77496','77495','77494','77493','77492','77491','77490',
'77489','77488','77487','77486','77485','77484','77483','77482','77481','77480',
'77479','77478','77477','77476','77475','77474','77473','77472','77471','77470',
'77469','77468','77467','77466','77465','77464','77463','77462','77461','77460',
'77459','77458','77457','77456','77455','77454','77453','77452','77451','77450',
'77449','77448','77447','77446','77445','77444','77443','77442','77441','77440',
'77439','77438','77437','77436','77435','77434','77433','77432','77431','77430',
'77429','77428','77427','77426','77425','77424','77423','77422','77421','77420',
'77419','77418','77417','77416','77415','77414','77413','77412','77411','77410',
'77409','77408','77407','77406','77405','77404','77403','77402','77401','77400',
'77399','77398','77397','77396','77395','77394','77393','77392','77391','77390',
'77389','77388','77387','77386','77385','77384','77383','77382','77381','77380',
'77379','77378','77377','77376','77375','77374','77373','77372','77371','77370',
'77369','77368','77367','77366','77365','77364','77363','77362','77361','77360',
'77359','77358','77357','77356','77355','77354','77353','77352','77351','77350',
'77349','77348','77347','77346','77345','77344','77343','77342','77341','77340',
'77339','77338','77337','77336','77335','77334','77333','77332','77331','77330',
'77329','77328','77327','77326','77325','77324','77323','77322','77321','77320',
'77319','77318','77317','77316','77315','77314','77313','77312','77311','77310',
'77309','77308','77307','77306','77305','77304','77303','77302','77301','77300',
'77299','77298','77297','77296','77295','77294','77293','77292','77291','77290',
'77289','77288','77287','77286','77285','77284','77283','77282','77281','77280',
'77279','77278','77277','77276','77275','77274','77273','77272','77271','77270',
'77269','77268','77267','77266','77265','77264','77263','77262','77261','77260',
'77259','77258','77257','77256','77255','77254','77253','77252','77251','77250',
'77249','77248','77247','77246','77245','77244','77243','77242','77241','77240',
'77239','77238','77237','77236','77235','77234','77233','77232','77231','77230',
'77229','77228','77227','77226','77225','77224','77223','77222','77221','77220',
'77219','77218','77217','77216','77215','77214','77213','77212','77211','77210',
'77209','77208','77207','77206','77205','77204','77203','77202','77201','77200',
'77199','77198','77197','77196','77195','77194','77193','77192','77191','77190',
'77189','77188','77187','77186','77185','77184','77183','77182','77181','77180',
'77179','77178','77177','77176','77175','77174','77173','77172','77171','77170',
'77169','77168','77167','77166','77165','77164','77163','77162','77161','77160',
'77159','77158','77157','77156','77155','77154','77153','77152','77151','77150',
'77149','77148','77147','77146','77145','77144','77143','77142','77141','77140',
'77139','77138','77137','77136','77135','77134','77133','77132','77131','77130',
'77129','77128','77127','77126','77125','77124','77123','77122','77121','77120',
'77119','77118','77117','77116','77115','77114','77113','77112','77111','77110',
'77109','77108','77107','77106','77105','77104','77103','77102','77101','77100',
'77099','77098','77097','77096','77095','77094','77093','77092','77091','77090',
'77089','77088','77087','77086','77085','77084','77083','77082','77081','77080',
'77079','77078','77077','77076','77075','77074','77073','77072','77071','77070',
'77069','77068','77067','77066','77065','77064','77063','77062','77061','77060',
'77059','77058','77057','77056','77055','77054','77053','77052','77051','77050',
'77049','77048','77047','77046','77045','77044','77043','77042','77041','77040',
'77039','77038','77037','77036','77035','77034','77033','77032','77031','77030',
'77029','77028','77027','77026','77025','77024','77023','77022','77021','77020',
'77019','77018','77017','77016','77015','77014','77013','77012','77011','77010',
'77009','77008','77007','77006','77005','77004','77003','77002','77001','77000',
'76999','76998','76997','76996','76995','76994','76993','76992','76991','76990'
]





# Store results here
results = []

# ---------------- Loop through zip codes ----------------
for zc in zip_codes:
    try:
        print(f"\nProcessing zip code: {zc}")

        # Step 1: Enter zip code
        try:
            zip_input = WebDriverWait(driver, 5).until(
                EC.element_to_be_clickable((By.CLASS_NAME, "gbmc-zipcode-input"))
            )
            zip_input.clear()
            zip_input.send_keys(zc + Keys.ENTER)
        except TimeoutException:
            print("Zip input not available, maybe we're already in checkout flow.")

        time.sleep(2)

        # Step 2: Check for available buttons
        try:
            element = WebDriverWait(driver, 5).until(
                EC.any_of(
                    EC.presence_of_element_located((By.CLASS_NAME, "gbmc-back-button")),
                    EC.presence_of_element_located((By.CLASS_NAME, "gbmc-change-zipcode-link"))
                )
            )
            # ✅ If found → availability = Yes
            results.append({"zipcode": zc, "availability": "Yes"})

            # Re-find element to avoid stale reference
            element = driver.find_element(By.CLASS_NAME, element.get_attribute("class").split()[0])

            if "gbmc-back-button" in element.get_attribute("class"):
                print(f"Zip {zc} accepted -> back button present.")
                element.click()
            elif "gbmc-change-zipcode-link" in element.get_attribute("class"):
                print(f"Zip {zc} accepted -> change zip link present.")
                element.click()

        except TimeoutException:
            # ❌ If not found → availability = No
            print(f"Neither back nor change-zip buttons present for zip {zc}, marking as No...")
            results.append({"zipcode": zc, "availability": "No"})

            # Recovery flow
            try:
                headed_back = WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((By.CLASS_NAME, "gbmc-headed-back-button"))
                )
                headed_back.click()
                time.sleep(1)

                WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((By.ID, "intentionButtonList"))
                ).click()
                time.sleep(1)
                print(f"Recovered successfully for zip {zc}")

            except Exception:
                print(f"Recovery failed for zip {zc}")
                continue

    except Exception as e:
        print(f"Unexpected error with zip {zc}: {e}")
        results.append({"zipcode": zc, "availability": "No"})

time.sleep(5)
driver.quit()

# ---------------- Save results ----------------
df = pd.DataFrame(results)
df.to_csv("zipcode_availability24000.csv", index=False)
print("\n✅ Dataset saved as zip_availability.csv")

import pandas as pd
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.common.keys import Keys
from selenium.common.exceptions import TimeoutException
import time

# ---------------- Setup ----------------
chrome_options = Options()
chrome_options.add_argument("--start-maximized")

service = Service(r"C:\Users\Lenovo\Downloads\chromedriver-win64 (1)\chromedriver-win64\chromedriver.exe")
driver = webdriver.Chrome(service=service, options=chrome_options)

driver.get("https://www.rewe.de/shop")
time.sleep(3)

# Click initial entry button
WebDriverWait(driver, 10).until(
    EC.element_to_be_clickable((By.ID, "intentionButtonList"))
).click()

# ---------------- Zip codes list ----------------

zip_codes = numbers = [
"63897","63879","63989","63988","63987","63986","63985","63984","63983","63982","63981","63980",
"63979","63978","63977","63976","63975","63974","63973","63972","63971","63970",
"63969","63968","63967","63966","63965","63964","63963","63962","63961","63960",
"63959","63958","63957","63956","63955","63954","63953","63952","63951","63950",
"63949","63948","63947","63946","63945","63944","63943","63942","63941","63940",
"63939","63938","63937","63936","63935","63934","63933","63932","63931","63930",
"63929","63928","63927","63926","63925","63924","63923","63922","63921","63920",
"63919","63918","63917","63916","63915","63914","63913","63912","63911","63910",
"63909","63908","63907","63906","63905","63904","63903","63902","63901","63900",
"63899","63898","63897","63896","63895","63894","63893","63892","63891","63890",
"63889","63888","63887","63886","63885","63884","63883","63882","63881","63880",
"63879","63878","63877","63876","63875","63874","63873","63872","63871","63870",
"63869","63868","63867","63866","63865","63864","63863","63862","63861","63860",
"63859","63858","63857","63856","63855","63854","63853","63852","63851","63850",
"63849","63848","63847","63846","63845","63844","63843","63842","63841","63840",
"63839","63838","63837","63836","63835","63834","63833","63832","63831","63830",
"63829","63828","63827","63826","63825","63824","63823","63822","63821","63820",
"63819","63818","63817","63816","63815","63814","63813","63812","63811","63810",
"63809","63808","63807","63806","63805","63804","63803","63802","63801","63800",
"63799","63798","63797","63796","63795","63794","63793","63792","63791","63790",
"63789","63788","63787","63786","63785","63784","63783","63782","63781","63780",
"63779","63778","63777","63776","63775","63774","63773","63772","63771","63770",
"63769","63768","63767","63766","63765","63764","63763","63762","63761","63760",
"63759","63758","63757","63756","63755","63754","63753","63752","63751","63750",
"63749","63748","63747","63746","63745","63744","63743","63742","63741","63740",
"63739","63738","63737","63736","63735","63734","63733","63732","63731","63730",
"63729","63728","63727","63726","63725","63724","63723","63722","63721","63720",
"63719","63718","63717","63716","63715","63714","63713","63712","63711","63710",
"63709","63708","63707","63706","63705","63704","63703","63702","63701","63700",
"63699","63698","63697","63696","63695","63694","63693","63692","63691","63690",
"63689","63688","63687","63686","63685","63684","63683","63682","63681","63680",
"63679","63678","63677","63676","63675","63674","63673","63672","63671","63670",
"63669","63668","63667","63666","63665","63664","63663","63662","63661","63660",
"63659","63658","63657","63656","63655","63654","63653","63652","63651","63650",
"63649","63648","63647","63646","63645","63644","63643","63642","63641","63640",
"63639","63638","63637","63636","63635","63634","63633","63632","63631","63630",
"63629","63628","63627","63626","63625","63624","63623","63622","63621","63620",
"63619","63618","63617","63616","63615","63614","63613","63612","63611","63610",
"63609","63608","63607","63606","63605","63604","63603","63602","63601","63600",
"63599","63598","63597","63596","63595","63594","63593","63592","63591","63590",
"63589","63588","63587","63586","63585","63584","63583","63582","63581","63580",
"63579","63578","63577","63576","63575","63574","63573","63572","63571","63570",
"63569","63568","63567","63566","63565","63564","63563","63562","63561","63560",
"63559","63558","63557","63556","63555","63554","63553","63552","63551","63550",
"63549","63548","63547","63546","63545","63544","63543","63542","63541","63540",
"63539","63538","63537","63536","63535","63534","63533","63532","63531","63530",
"63529","63528","63527","63526","63525","63524","63523","63522","63521","63520",
"63519","63518","63517","63516","63515","63514","63513","63512","63511","63510",
"63509","63508","63507","63506","63505","63504","63503","63502","63501","63500",
"63499","63498","63497","63496","63495","63494","63493","63492","63491","63490",
"63489","63488","63487","63486","63485","63484","63483","63482","63481","63480",
"63479","63478","63477","63476","63475","63474","63473","63472","63471","63470",
"63469","63468","63467","63466","63465","63464","63463","63462","63461","63460",
"63459","63458","63457","63456","63455","63454","63453","63452","63451","63450",
"63449","63448","63447","63446","63445","63444","63443","63442","63441","63440",
"63439","63438","63437","63436","63435","63434","63433","63432","63431","63430",
"63429","63428","63427","63426","63425","63424","63423","63422","63421","63420",
"63419","63418","63417","63416","63415","63414","63413","63412","63411","63410",
"63409","63408","63407","63406","63405","63404","63403","63402","63401","63400",
"63399","63398","63397","63396","63395","63394","63393","63392","63391","63390",
"63389","63388","63387","63386","63385","63384","63383","63382","63381","63380",
"63379","63378","63377","63376","63375","63374","63373","63372","63371","63370",
"63369","63368","63367","63366","63365","63364","63363","63362","63361","63360",
"63359","63358","63357","63356","63355","63354","63353","63352","63351","63350",
"63349","63348","63347","63346","63345","63344","63343","63342","63341","63340",
"63339","63338","63337","63336","63335","63334","63333","63332","63331","63330",
"63329","63328","63327","63326","63325","63324","63323","63322","63321","63320",
"63319","63318","63317","63316","63315","63314","63313","63312","63311","63310",
"63309","63308","63307","63306","63305","63304","63303","63302","63301","63300",
"63299","63298","63297","63296","63295","63294","63293","63292","63291","63290",
"63289","63288","63287","63286","63285","63284","63283","63282","63281","63280",
"63279","63278","63277","63276","63275","63274","63273","63272","63271","63270",
"63269","63268","63267","63266","63265","63264","63263","63262","63261","63260",
"63259","63258","63257","63256","63255","63254","63253","63252","63251","63250",
"63249","63248","63247","63246","63245","63244","63243","63242","63241","63240",
"63239","63238","63237","63236","63235","63234","63233","63232","63231","63230",
"63229","63228","63227","63226","63225","63224","63223","63222","63221","63220",
"63219","63218","63217","63216","63215","63214","63213","63212","63211","63210",
"63209","63208","63207","63206","63205","63204","63203","63202","63201","63200",
"63199","63198","63197","63196","63195","63194","63193","63192","63191","63190",
"63189","63188","63187","63186","63185","63184","63183","63182","63181","63180",
"63179","63178","63177","63176","63175","63174","63173","63172","63171","63170",
"63169","63168","63167","63166","63165","63164","63163","63162","63161","63160",
"63159","63158","63157","63156","63155","63154","63153","63152","63151","63150",
"63149","63148","63147","63146","63145","63144","63143","63142","63141","63140",
"63139","63138","63137","63136","63135","63134","63133","63132","63131","63130",
"63129","63128","63127","63126","63125","63124","63123","63122","63121","63120",
"63119","63118","63117","63116","63115","63114","63113","63112","63111","63110",
"63109","63108","63107","63106","63105","63104","63103","63102","63101","63100",
"63099","63098","63097","63096","63095","63094","63093","63092","63091","63090",
"63089","63088","63087","63086","63085","63084","63083","63082","63081","63080",
"63079","63078","63077","63076","63075","63074","63073","63072","63071","63070",
"63069","63068","63067","63066","63065","63064","63063","63062","63061","63060",
"63059","63058","63057","63056","63055","63054","63053","63052","63051","63050",
"63049","63048","63047","63046","63045","63044","63043","63042","63041","63040",
"63039","63038","63037","63036","63035","63034","63033","63032","63031","63030",
"63029","63028","63027","63026","63025","63024","63023","63022","63021","63020",
"63019","63018","63017","63016","63015","63014","63013","63012","63011","63010",
"63009","63008","63007","63006","63005","63004","63003","63002","63001","63000",
"62999","62998","62997","62996","62995","62994","62993","62992","62991","62990"
]


# Store results here
results = []

# ---------------- Loop through zip codes ----------------
for zc in zip_codes:
    try:
        print(f"\nProcessing zip code: {zc}")

        # Step 1: Enter zip code
        try:
            zip_input = WebDriverWait(driver, 5).until(
                EC.element_to_be_clickable((By.CLASS_NAME, "gbmc-zipcode-input"))
            )
            zip_input.clear()
            zip_input.send_keys(zc + Keys.ENTER)
        except TimeoutException:
            print("Zip input not available, maybe we're already in checkout flow.")

        time.sleep(2)

        # Step 2: Check for available buttons
        try:
            element = WebDriverWait(driver, 5).until(
                EC.any_of(
                    EC.presence_of_element_located((By.CLASS_NAME, "gbmc-back-button")),
                    EC.presence_of_element_located((By.CLASS_NAME, "gbmc-change-zipcode-link"))
                )
            )
            # ✅ If found → availability = Yes
            results.append({"zipcode": zc, "availability": "Yes"})

            # Re-find element to avoid stale reference
            element = driver.find_element(By.CLASS_NAME, element.get_attribute("class").split()[0])

            if "gbmc-back-button" in element.get_attribute("class"):
                print(f"Zip {zc} accepted -> back button present.")
                element.click()
            elif "gbmc-change-zipcode-link" in element.get_attribute("class"):
                print(f"Zip {zc} accepted -> change zip link present.")
                element.click()

        except TimeoutException:
            # ❌ If not found → availability = No
            print(f"Neither back nor change-zip buttons present for zip {zc}, marking as No...")
            results.append({"zipcode": zc, "availability": "No"})

            # Recovery flow
            try:
                headed_back = WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((By.CLASS_NAME, "gbmc-headed-back-button"))
                )
                headed_back.click()
                time.sleep(1)

                WebDriverWait(driver, 5).until(
                    EC.element_to_be_clickable((By.ID, "intentionButtonList"))
                ).click()
                time.sleep(1)
                print(f"Recovered successfully for zip {zc}")

            except Exception:
                print(f"Recovery failed for zip {zc}")
                continue

    except Exception as e:
        print(f"Unexpected error with zip {zc}: {e}")
        results.append({"zipcode": zc, "availability": "No"})

time.sleep(5)
driver.quit()

# ---------------- Save results ----------------
df = pd.DataFrame(results)
df.to_csv("zipcode_availability38000.csv", index=False)
print("\n✅ Dataset saved as zip_availability.csv")
